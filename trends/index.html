<!DOCTYPE html>
<html>
<title>Halalan 2016 - Philippine ElectionsTwitter Statistics</title>
<meta charset="utf-8">
<head>
<style>

body {
  font: 10px sans-serif;
}

/* For the chord diagram */
.chord {
  fill-opacity: .67;
  stroke: #000;
  stroke-width: .5px;
}

/* For the bar graph */
.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

</style>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<!--script src="https://code.jquery.com/jquery-2.2.2.min.js"></script-->
</head>
<body>
  <div id="barGraph"></div>
  <div id="chordDiagram"></div>
</body>
<script>
/* Binay, Mar, Poe, Miriam, Duterte, Gringo, Leni, Chiz, Bongbong, Cayetano */
var colors = ['#ffa500', '#f2f238', '#add8e6', '#ff0000', '#98fb98', '#551a8b', '#000000', '#ff69b4', '#f4a460', '#008080'];

</script>
<script>
/* For the chord diagram */
var outerRadius = 960 / 2,
    innerRadius = outerRadius - 130;

var fill = d3.scale.category20c();

var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

function drawChord(imports) {

  var csvg = d3.select("#chordDiagram").append("svg")
      .attr("width", outerRadius * 2)
      .attr("height", outerRadius * 2)
    .append("g")
      .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");

  var indexByName = d3.map(),
      nameByIndex = d3.map(),
      matrix = [],
      n = 0;

  // Compute a unique index for each candidate name.
  imports.forEach(function(d) {
    if (!indexByName.has(d = d.name)) {
      nameByIndex.set(n, d);
      indexByName.set(d, n++);
    }
  });

  // Construct a square matrix counting mentions between candidates.
  imports.forEach(function(d) {
    var source = indexByName.get(d.name),
        row = matrix[source];
    if (!row) {
     row = matrix[source] = [];
     for (var i = -1; ++i < n;) row[i] = 0;
    }
    $.each($.parseJSON(JSON.stringify(d.rel)), function(k, v){
      row[k] = v;
    });
  });

  var chord = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.descending)
    .sortChords(d3.descending);

  chord.matrix(matrix);

  var g = csvg.selectAll(".group")
      .data(chord.groups)
    .enter().append("g")
      .attr("class", "group");

  g.append("path")
      .style("fill", function(d) { return colors[d.index]; })
      .style("stroke", function(d) { return colors[d.index]; })
      .attr("d", arc)
      .on("mouseover", fade(.1))
      .on("mouseout", fade(1));

  var groupText = g.append("text")
      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
      .attr("dy", ".35em")
      .attr("transform", function(d) {
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
            + "translate(" + (innerRadius + 26) + ")"
            + (d.angle > Math.PI ? "rotate(180)" : "");
      })
      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .text(function(d) { return nameByIndex.get(d.index); });

  // Add a mouseover title.
  g.append("title").text(function(d, i) {
    return nameByIndex.get(i) + ": " + (d.value) + " total posts with other candidates";
  });

  groupText.append("textPath")
      .attr("xlink:href", function(d, i) { return "#group" + i; })
      .text(function(d, i) { return nameByIndex.get(i); });

  var chords = csvg.selectAll(".chord")
      .data(chord.chords)
    .enter().append("path")
      .attr("class", "chord")
      .style("stroke", function(d) { return d3.rgb(colors[d.source.index]).darker(); })
      .style("fill", function(d) { return colors[d.source.index]; })
      .attr("d", d3.svg.chord().radius(innerRadius));

  function fade(opacity) {
    return function(g, i) {
      csvg.selectAll("path.chord")
          .filter(function(d) { return d.source.index != i && d.target.index != i; })
        .transition()
          .style("opacity", opacity);
    };
  }

    // Add an elaborate mouseover title for each chord.
  chords.append("title").text(function(d) {
    return nameByIndex.get(d.source.index)
        + " â‡” " + nameByIndex.get(d.target.index)
        + ": " + d.source.value + " tweets";
  });
}

d3.select(self.frameElement).style("height", outerRadius * 2 + "px");

</script>
<script>
/* For the bar graph */

var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(10);

function drawBar(data) {

  var bsvg = d3.select("#barGraph").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  x.domain(data.map(function(d) { return d.name; }));
  y.domain([0, d3.max(data, function(d) { return d.posts_count; })]);

  bsvg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  bsvg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Tweets");

  bsvg.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.name); })
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.posts_count); })
      .attr("height", function(d) { return height - y(d.posts_count); })
      .style("fill", function(d) { return colors[d.id]; })
      .on("mouseover", fade(.1))
      .on("mouseout", fade(1))
      .append("title").text(function(d){
        return d.name + ": " + d.posts_count + " total tweets";
      });

  function fade(opacity) {
    return function(g, i) {
      bsvg.selectAll("rect.bar")
          .filter(function(d) { return d.id != i; })
        .transition()
          .style("opacity", opacity);
    };
  }
}
</script>
<script>
var ws = new WebSocket("ws://localhost:8888/ws");
ws.onmessage = function(evt) {
  d3.select("#chordDiagram").selectAll("svg").remove();
  d3.select("#barGraph").selectAll("svg").remove();
  drawChord(JSON.parse(evt.data));
  drawBar(JSON.parse(evt.data));
};
</script>
</html>
